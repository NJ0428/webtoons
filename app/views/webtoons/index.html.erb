

<main class="max-w-7xl mx-auto px-4 py-6">

  <!-- 메인 배너 -->
  <section class="mb-8">
    <div class="relative bg-gradient-to-r from-purple-500 to-violet-600 rounded-lg overflow-hidden h-80">
      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
      <div class="relative z-10 flex items-center justify-center h-full">
        <div class="text-center text-white">
          <h2 class="text-4xl font-bold mb-4">오늘의 추천 웹툰</h2>
          <p class="text-xl opacity-90">매일 새로운 재미를 만나보세요</p>
        </div>
      </div>
    </div>
  </section>

  <!-- 요일별 웹툰 탭 -->
  <section class="mb-8">
    <div class="flex justify-center mb-6">
      <div class="flex bg-gray-100 rounded-lg p-1">
        <% 
          days = %w[월 화 수 목 금 토 일]
          today_index = 5  # 토요일 (0=월요일, 5=토요일)
        %>
        <% days.each_with_index do |day, index| %>
          <button onclick="switchDay('<%= day %>', this)" 
                  class="day-tab px-6 py-2 rounded-md font-medium transition-colors <%= index == today_index ? 'bg-purple-600 text-white active' : 'text-gray-600 hover:text-purple-600' %>"
                  data-day="<%= day %>">
            <%= day %>
          </button>
        <% end %>
      </div>
    </div>
  </section>

  <!-- 메인 콘텐츠 -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- 웹툰 그리드 -->
    <div class="lg:col-span-3">
      <div class="flex justify-between items-center mb-6">
        <h2 id="day-title" class="text-2xl font-bold text-gray-900">토요일 웹툰</h2>
        <a href="/webtoon" class="text-purple-600 hover:text-purple-700 font-medium flex items-center">
          더보기
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
      
      <div id="webtoon-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <!-- 웹툰 목록이 여기에 동적으로 로드됩니다 -->
      </div>
    </div>

    <!-- 사이드바 -->
    <div class="space-y-6">
      <!-- 인기 급상승 -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="font-bold text-lg mb-4 flex items-center">
          <span class="text-red-500 mr-2">🔥</span>
          인기 급상승
        </h3>
        <ul class="space-y-3">
          <% @trending_comics.each_with_index do |comic, index| %>
            <li class="flex items-center hover:bg-gray-50 p-2 rounded cursor-pointer transition-colors duration-200"
                onclick="location.href='/webtoon/list?titleId=<%= comic.id %>&tab=<%= comic.day_of_week %>'">
              <span class="font-bold text-lg mr-3 w-6 text-center <%= index < 3 ? 'text-red-500' : 'text-gray-500' %>">
                <%= index + 1 %>
              </span>
              <div class="w-10 h-12 rounded mr-3 flex-shrink-0 overflow-hidden">
                <img src="https://picsum.photos/40/48?random=<%= comic.id + 200 %>" 
                     alt="<%= comic.title %>" 
                     class="w-full h-full object-cover">
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate"><%= comic.title %></p>
                <p class="text-xs text-gray-500"><%= comic.author %></p>
                <div class="flex items-center mt-1">
                  <span class="text-xs text-green-600 font-medium">
                    ⭐ <%= comic.rating %>
                  </span>
                  <span class="text-xs text-gray-400 ml-2">
                    👁 <%= number_with_delimiter(comic.view_count) %>
                  </span>
                </div>
              </div>
              <div class="flex items-center">
                <% if index < 3 %>
                  <span class="text-red-500 text-xs">🔥</span>
                <% elsif comic.view_count > 100000 %>
                  <span class="text-orange-500 text-xs">📈</span>
                <% end %>
              </div>
            </li>
          <% end %>
        </ul>
      </div>

      <!-- 완결 웹툰 -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="font-bold text-lg mb-4 flex items-center">
          <span class="text-blue-500 mr-2">✨</span>
          완결 웹툰
        </h3>
        <div class="space-y-3">
          <% if @completed_comics&.any? %>
            <% @completed_comics.each do |comic| %>
              <div class="flex items-center hover:bg-gray-50 p-2 rounded cursor-pointer transition-colors duration-200"
                   onclick="location.href='/webtoon/list?titleId=<%= comic.id %>&tab=<%= comic.day_of_week %>'">
                <div class="w-12 h-16 rounded mr-3 flex-shrink-0 overflow-hidden">
                  <img src="https://picsum.photos/48/64?random=<%= comic.id + 300 %>" 
                       alt="<%= comic.title %>" 
                       class="w-full h-full object-cover">
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate"><%= comic.title %></p>
                  <p class="text-xs text-gray-500"><%= comic.author %></p>
                  <div class="flex items-center mt-1">
                    <span class="text-xs text-blue-600 font-medium">
                      ⭐ <%= comic.rating %>
                    </span>
                    <span class="text-xs text-gray-400 ml-2">완결</span>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <% 5.times do |i| %>
              <div class="flex items-center hover:bg-gray-50 p-2 rounded cursor-pointer">
                <div class="w-12 h-16 rounded mr-3 flex-shrink-0 overflow-hidden">
                  <img src="https://picsum.photos/48/64?random=<%= 100 + i %>" 
                       alt="완결 웹툰 <%= i + 1 %>" 
                       class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">완결 웹툰 <%= i + 1 %></p>
                  <p class="text-xs text-gray-500">작가명</p>
                  <div class="flex items-center mt-1">
                    <span class="text-xs text-blue-600 font-medium">⭐ 4.<%= rand(1..9) %></span>
                    <span class="text-xs text-gray-400 ml-2">완결</span>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 추가 섹션들 -->
  <section class="mt-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">장르별 추천</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
      <% 
        genres = [
          { name: '로맨스', emoji: '💕', color: 'from-pink-400 to-red-400' },
          { name: '액션', emoji: '⚔️', color: 'from-orange-400 to-red-500' },
          { name: '판타지', emoji: '🔮', color: 'from-purple-400 to-indigo-500' },
          { name: '일상', emoji: '☕', color: 'from-green-400 to-blue-400' },
          { name: '개그', emoji: '😂', color: 'from-yellow-400 to-orange-400' },
          { name: '스릴러', emoji: '🔪', color: 'from-gray-600 to-black' }
        ]
      %>
      <% genres.each do |genre| %>
        <div class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:shadow-md transition-shadow cursor-pointer group">
          <div class="w-16 h-16 bg-gradient-to-br <%= genre[:color] %> rounded-full mx-auto mb-3 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform duration-200">
            <%= genre[:emoji] %>
          </div>
          <p class="font-medium text-gray-900 group-hover:text-purple-600 transition-colors"><%= genre[:name] %></p>
        </div>
      <% end %>
    </div>
  </section>
</main>

<script>
// 오늘 요일 가져오기 (0=일요일, 1=월요일, ..., 6=토요일)
function getTodayKoreanDay() {
  const days = ['일', '월', '화', '수', '목', '금', '토'];
  const today = new Date().getDay();
  return days[today];
}

// 현재 선택된 요일 (서버에서 전달받은 값 또는 오늘 날짜)
let currentDay = '<%= @current_day %>' || getTodayKoreanDay();

// 페이지 로드 시 초기 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
  // 오늘 요일에 해당하는 탭을 활성화
  const todayTab = document.querySelector(`[data-day="${currentDay}"]`);
  if (todayTab) {
    // 모든 탭 비활성화
    document.querySelectorAll('.day-tab').forEach(tab => {
      tab.classList.remove('bg-purple-600', 'text-white', 'active');
      tab.classList.add('text-gray-600', 'hover:text-purple-600');
    });
    
    // 오늘 탭 활성화
    todayTab.classList.remove('text-gray-600', 'hover:text-purple-600');
    todayTab.classList.add('bg-purple-600', 'text-white', 'active');
  }
  
  // 제목 업데이트
  document.getElementById('day-title').textContent = `${currentDay}요일 웹툰`;
  
  // 초기 웹툰 목록 표시 (서버에서 이미 로드된 데이터 사용)
  displayInitialWebtoons();
  
  // 인기 급상승 새로고침 버튼 이벤트 추가
  addTrendingRefreshButton();
  
  // 5분마다 인기 급상승 자동 업데이트
  setInterval(loadTrendingWebtoons, 5 * 60 * 1000);
});

// 초기 웹툰 목록 표시 (서버에서 전달받은 데이터)
function displayInitialWebtoons() {
  const grid = document.getElementById('webtoon-grid');
  const comics = [
    <% @comics.each do |comic| %>
      {
        id: <%= comic.id %>,
        title: '<%= j comic.title %>',
        author: '<%= j comic.author %>',
        thumbnail: '<%= comic.thumbnail_url %>',
        isNew: <%= comic.is_new %>,
        rating: <%= comic.rating %>,
        viewCount: <%= comic.view_count %>,
        genre: '<%= comic.genre %>'
      },
    <% end %>
  ];
  
  displayWebtoons(comics, currentDay);
}

// 요일 전환 함수
function switchDay(day, buttonElement) {
  // 이전 활성 탭 비활성화
  document.querySelectorAll('.day-tab').forEach(tab => {
    tab.classList.remove('bg-purple-600', 'text-white', 'active');
    tab.classList.add('text-gray-600', 'hover:text-purple-600');
  });
  
  // 새 탭 활성화
  buttonElement.classList.remove('text-gray-600', 'hover:text-purple-600');
  buttonElement.classList.add('bg-purple-600', 'text-white', 'active');
  
  // 현재 요일 업데이트
  currentDay = day;
  
  // 제목 업데이트
  document.getElementById('day-title').textContent = `${day}요일 웹툰`;
  
  // 웹툰 목록 로드
  loadWebtoons(day);
}

// API에서 웹툰 목록 로드 함수
async function loadWebtoons(day) {
  const grid = document.getElementById('webtoon-grid');
  
  // 로딩 표시
  grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">로딩 중...</div>';
  
  try {
    const response = await fetch(`/api/webtoons/by_day/${day}`);
    const comics = await response.json();
    
    setTimeout(() => {
      displayWebtoons(comics, day);
    }, 300);
  } catch (error) {
    console.error('웹툰 데이터 로드 실패:', error);
    grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">데이터를 불러오는데 실패했습니다.</div>';
  }
}

// 웹툰 목록 표시 함수
function displayWebtoons(comics, day) {
  const grid = document.getElementById('webtoon-grid');
  
  if (comics.length === 0) {
    grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">해당 요일에 연재되는 웹툰이 없습니다.</div>';
    return;
  }
  
  grid.innerHTML = comics.map((comic, index) => `
    <div class="group cursor-pointer">
      <a href="/webtoon/list?titleId=${comic.id}&tab=${day}" class="block">
        <div class="relative overflow-hidden rounded-lg mb-3">
          <img src="https://picsum.photos/200/300?random=${comic.id || index + 50}" 
               alt="${comic.title}" 
               class="aspect-[3/4] w-full object-cover group-hover:scale-105 transition-transform duration-200">
          ${comic.isNew ? '<div class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded">UP</div>' : ''}
          <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
            ⭐ ${comic.rating}
          </div>
        </div>
        <h3 class="font-bold text-gray-900 text-sm mb-1 line-clamp-2 group-hover:text-purple-600 transition-colors">
          ${comic.title}
        </h3>
        <p class="text-gray-600 text-xs">${comic.author}</p>
        <p class="text-gray-500 text-xs mt-1">${comic.genre} • 조회수 ${formatViewCount(comic.viewCount)}</p>
      </a>
    </div>
  `).join('');
}

// 조회수 포맷팅 함수
function formatViewCount(count) {
  if (count >= 1000000) {
    return Math.floor(count / 100000) / 10 + 'M';
  } else if (count >= 1000) {
    return Math.floor(count / 100) / 10 + 'K';
  }
  return count.toString();
}

// 인기 급상승 새로고침 버튼 추가
function addTrendingRefreshButton() {
  const trendingHeader = document.querySelector('.bg-white .font-bold');
  if (trendingHeader && trendingHeader.textContent.includes('인기 급상승')) {
    const refreshButton = document.createElement('button');
    refreshButton.innerHTML = '🔄';
    refreshButton.className = 'ml-2 text-gray-400 hover:text-gray-600 transition-colors duration-200 text-sm';
    refreshButton.title = '인기 급상승 새로고침';
    refreshButton.onclick = loadTrendingWebtoons;
    trendingHeader.appendChild(refreshButton);
  }
}

// 인기 급상승 웹툰 로드
async function loadTrendingWebtoons() {
  try {
    const response = await fetch('/api/webtoons/trending');
    const trendingComics = await response.json();
    
    updateTrendingList(trendingComics);
  } catch (error) {
    console.error('인기 급상승 데이터 로드 실패:', error);
  }
}

// 인기 급상승 목록 업데이트
function updateTrendingList(trendingComics) {
  const trendingList = document.querySelector('.bg-white ul');
  if (!trendingList) return;
  
  trendingList.innerHTML = trendingComics.map(comic => `
    <li class="flex items-center hover:bg-gray-50 p-2 rounded cursor-pointer transition-colors duration-200"
        onclick="location.href='/webtoon/list?titleId=${comic.id}&tab=${comic.dayOfWeek}'">
      <span class="font-bold text-lg mr-3 w-6 text-center ${comic.isTopThree ? 'text-red-500' : 'text-gray-500'}">
        ${comic.rank}
      </span>
      <div class="w-10 h-12 rounded mr-3 flex-shrink-0 overflow-hidden">
        <img src="https://picsum.photos/40/48?random=${comic.id + 200}" 
             alt="${comic.title}" 
             class="w-full h-full object-cover">
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium text-gray-900 truncate">${comic.title}</p>
        <p class="text-xs text-gray-500">${comic.author}</p>
        <div class="flex items-center mt-1">
          <span class="text-xs text-green-600 font-medium">
            ⭐ ${comic.rating}
          </span>
          <span class="text-xs text-gray-400 ml-2">
            👁 ${formatViewCount(comic.viewCount)}
          </span>
        </div>
      </div>
      <div class="flex items-center">
        ${comic.isTopThree ? '<span class="text-red-500 text-xs">🔥</span>' : 
          (comic.viewCount > 100000 ? '<span class="text-orange-500 text-xs">📈</span>' : '')}
      </div>
    </li>
  `).join('');
}


</script>